<!DOCTYPE html>
<html>

<head>
  <title>OPFS Test Iframe</title>
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline'; default-src data: blob: mediastream: filesystem:; style-src 'self' 'unsafe-inline'; child-src 'self' blob:; worker-src blob: 'self';">
    <meta http-equiv="x-dns-prefetch-control" content="off">
</head>

<body>
  <h3>OPFS Test Iframe (Origin: localhost:3000)</h3>
  <button onclick="doAction('write')">Write</button>
  <button onclick="doAction('read')">Read</button>
  <div id="iframeResult">No operations performed yet</div>
  <script>
async function handleOPFS(action, data) {
  try {
    const root = await navigator.storage.getDirectory();

    if (action === 'write') {
      const file = await root.getFileHandle('test.txt', { create: true });
      const writer = await file.createWritable();
      await writer.write(data || 'TEST-' + new Date().toISOString());
      await writer.close();
      return 'Written successfully';
    }

    if (action === 'read') {
      const file = await root.getFileHandle('test.txt');
      const text = await (await file.getFile()).text();
      return 'Read: ' + text;
    }
  } catch (err) {
    return 'Error: ' + err.message;
  }
}

// Keep track of parent windows that have contacted us
const connectedParents = new Set();

// Broadcast result to all connected parents
function broadcast(result) {
  connectedParents.forEach(parent => {
    parent.source.postMessage(result, parent.origin);
  });
  document.getElementById('iframeResult').textContent = result;
}

async function doAction(action) {
  const result = await handleOPFS(action);
  broadcast(result);
}

// Restore message handling
window.addEventListener('message', async (e) => {
  if (true || e.origin.startsWith('http://localhost')) {
    // Store parent info for broadcasting
    connectedParents.add({
      source: e.source,
      origin: e.origin
    });
    const result = await handleOPFS(e.data.action);
    broadcast(result);
  }
});

// Auto-refresh content every second
setInterval(async () => {
  try {
    const result = await handleOPFS('read');
    broadcast(result);
  } catch (err) {
    // Ignore errors during auto-refresh
  }
}, 1000);

console.log('OPFS test iframe script loaded');
  </script>
</body>

</html>
